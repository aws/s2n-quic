<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>s2n-quic Guide</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">s2n-quic Guide</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/aws/s2n-quic" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p><code>s2n-quic</code> is a Rust implementation of the <a href="https://quicwg.org/">IETF QUIC protocol</a>.</p>
<h3 id="user-guide"><a class="header" href="#user-guide">User Guide</a></h3>
<p>If you are wanting to use <code>s2n-quic</code> in your application, you can find documentation on how to do that in the <a href="user-guide.html">user guide</a>.</p>
<h3 id="developer-guide"><a class="header" href="#developer-guide">Developer Guide</a></h3>
<p>If you are wanting to contribute and/or learn about implementation details of <code>s2n-quic</code>, please read the <a href="dev-guide.html">developer guide</a>.</p>
<h2 id="license"><a class="header" href="#license">License</a></h2>
<p><code>s2n-quic</code> source code and documentation is released under the <a href="https://aws.amazon.com/apache-2-0">Apache 2.0 License</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="debugging-s2n-quic"><a class="header" href="#debugging-s2n-quic">Debugging s2n-quic</a></h1>
<p>Before <a href="https://github.com/aws/s2n-quic/issues/new?template=s2n-quic-issue.md">opening an issue</a> regarding <code>s2n-quic</code>, you may be able to solve the issue on your own (or at least collect useful debugging information) by performing the actions contained within this section. Attaching the <a href="user-guide/debugging-tracelog.html">trace log</a> and <a href="user-guide/debugging-pcap.html">packet capture</a> from these actions to the issue increases our ability to address your issue in a timely manner.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="tracing-logs"><a class="header" href="#tracing-logs">Tracing logs</a></h2>
<p><code>s2n-quic</code> includes an Event framework that emits debugging information everytime a connection is started, a packet is received, a datagram is dropped, and <a href="https://docs.rs/s2n-quic/latest/s2n_quic/provider/event/trait.Subscriber.html#provided-methods">many other situations</a>. When the <code>provider-event-tracing</code> feature is enabled, the default behavior of <code>s2n-quic</code> is to emit these events via <a href="https://docs.rs/tracing">tracing</a>. Configuring a <code>tracing-subscriber</code> will allow for the events to be emitted to a log file or stdout. Follow these steps to emit a tracing log to stdout:</p>
<h3 id="1-enable-the-provider-event-tracing-feature"><a class="header" href="#1-enable-the-provider-event-tracing-feature">1. Enable the <code>provider-event-tracing</code> feature</a></h3>
<p>This feature is not enabled by default in <code>s2n-quic</code>, so specify it in your <code>Cargo.toml</code> in the <code>s2n-quic</code> dependency:</p>
<pre><code class="language-toml">[dependencies]
s2n-quic = { version = "1", features = ["provider-event-tracing"]}
</code></pre>
<h3 id="2-add-a-dependency-on-tracing-subscriber"><a class="header" href="#2-add-a-dependency-on-tracing-subscriber">2. Add a dependency on <code>tracing-subscriber</code></a></h3>
<p><code>tracing-subscriber</code> is used for collecting the event data emitted by <code>s2n-quic</code> and outputting it to stdout. The <code>env-filter</code> feature is used for turning logging off and on based on the <code>RUST_LOG</code> environment variable.</p>
<pre><code class="language-toml">[dependencies]
s2n-quic = { version = "1", features = ["provider-event-tracing"]}
tracing-subscriber = { version = "0.3", features = ["env-filter"] }
</code></pre>
<h3 id="3-configure-and-initialize-a-global-tracing-subscriber"><a class="header" href="#3-configure-and-initialize-a-global-tracing-subscriber">3. Configure and initialize a global <code>tracing-subscriber</code></a></h3>
<p>In your application code, prior to starting an <code>s2n-quic</code> server or client, include the following code to initialize a global <code>tracing-subscriber</code>.  This configuration allows for the <code>RUST_LOG</code> environment variable to determine the logging level.</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let format = tracing_subscriber::fmt::format()
    .with_level(false) // don't include levels in formatted output
    .with_timer(tracing_subscriber::fmt::time::uptime())
    .with_ansi(false) 
    .compact(); // Use a less verbose output format.

tracing_subscriber::fmt()
    .with_env_filter(tracing_subscriber::EnvFilter::from_default_env())
    .event_format(format)
    .init();
<span class="boring">}</span></code></pre></pre>
<h3 id="4-optional-specify-the--tracingsubscriber-event-provider-to-s2n-quic-server-or-client"><a class="header" href="#4-optional-specify-the--tracingsubscriber-event-provider-to-s2n-quic-server-or-client">4. [Optional] Specify the  <code>tracing::Subscriber</code> Event provider to <code>s2n-quic</code> server or client</a></h3>
<p>When the <code>provider-event-tracing</code> feature is enabled, the default behavior of <code>s2n-quic</code> is to emit these events via <a href="https://docs.rs/tracing">tracing</a>. If your application already makes use of a custom event subscriber, you may need to explicitly specify the default <code>event::tracing::Subscriber</code> by composing it with your existing event subscriber (<code>MyCustomEventSubscriber</code> in this example):</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let mut server = Server::builder()
   .with_tls((CERT_PEM, KEY_PEM))?
   .with_io("127.0.0.1:4433")?
   .with_event((
       MyCustomEventSubscriber,
       s2n_quic::provider::event::tracing::Subscriber::default(),
    ))?
   .start()?;
<span class="boring">}</span></code></pre></pre>
<h3 id="5-run-your-application-with-the-rust_log-environment-variable"><a class="header" href="#5-run-your-application-with-the-rust_log-environment-variable">5. Run your application with the <code>RUST_LOG</code> environment variable</a></h3>
<p>Now that everything has been configured, you can set the <code>RUST_LOG</code> environment variable to <code>debug</code> to start emitting debugging information:</p>
<pre><code class="language-bash"> $ RUST_LOG=debug cargo run --bin my_application
 0.032760542s s2n_quic:server: platform_feature_configured: configuration=Gso { max_segments: 1 }
 0.032954042s s2n_quic:server: platform_feature_configured: configuration=BaseMtu { mtu: 1228 }
 0.032964625s s2n_quic:server: platform_feature_configured: configuration=InitialMtu { mtu: 1228 }
 0.032971583s s2n_quic:server: platform_feature_configured: configuration=MaxMtu { mtu: 1228 }
 0.032978167s s2n_quic:server: platform_feature_configured: configuration=Gro { enabled: false }
 0.032987833s s2n_quic:server: platform_feature_configured: configuration=Ecn { enabled: true }
 0.033881250s s2n_quic:server: platform_event_loop_started: local_address=127.0.0.1:4433
...
</code></pre>
<p>Capture this output and attach it to your issue to aid with debugging.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="packet-capture"><a class="header" href="#packet-capture">Packet capture</a></h2>
<p>A packet capture allows for inspecting the contents of every packet transmitted or received by <code>s2n-quic</code>. Along with tracing logs, this can be very helpful for diagnosing issues. Follow these steps to record a packet capture.</p>
<h3 id="1-enable-key-logging-on-the-tls-provider"><a class="header" href="#1-enable-key-logging-on-the-tls-provider">1. Enable key logging on the TLS provider</a></h3>
<p>Since QUIC is an encrypted transport protocol, the payload of each packet is not readable in a standard packet capture. <code>s2n-quic</code> supports exporting the TLS session keys used by each QUIC connection so that the packet capture may be decrypted. Both the <code>s2n-tls</code> and <code>rustls</code> TLS providers support key logging through their associated builders:</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let tls = s2n_quic::provider::tls::default::Server::builder()
    .with_certificate(CERT_PEM, KEY_PEM)?
    .with_key_logging()?  // enables key logging
    .build()?;

let mut server = Server::builder()
   .with_tls(tls)?
   .with_io("127.0.0.1:4433")?
   .start()?;
<span class="boring">}</span></code></pre></pre>
<h4 id="2-start-capturing-packets"><a class="header" href="#2-start-capturing-packets">2. Start capturing packets</a></h4>
<p>Popular tools for capture packets include the command line tools <a href="https://www.tcpdump.org/">tcpdump</a> and <a href="https://www.wireshark.org/docs/man-pages/tshark.html">tshark</a>, as well as <a href="https://www.wireshark.org/">Wireshark</a>. Determine the network interface you are using for communicating with <code>s2n-quic</code> and provide it to the packet capture tool you prefer. The following example uses <code>tcpdump</code> to capture on the loopback interface and write the capture to a file:</p>
<pre><code class="language-bash">$ sudo tcpdump -i lo0 -w /var/tmp/mycapture.pcap
</code></pre>
<h4 id="3-run-your-application-with-the-sslkeylogfile-environment-variable"><a class="header" href="#3-run-your-application-with-the-sslkeylogfile-environment-variable">3. Run your application with the <code>SSLKEYLOGFILE</code> environment variable</a></h4>
<p>Set the <code>SSLKEYLOGFILE</code> environment variable to a file path to create a file containing the TLS session keys:</p>
<pre><code class="language-bash">$ SSLKEYLOGFILE=/var/tmp/keys.log cargo run --bin my_application
</code></pre>
<h4 id="4-optional-embed-the-key-log-in-the-packet-capture-file"><a class="header" href="#4-optional-embed-the-key-log-in-the-packet-capture-file">4. [Optional] Embed the key log in the packet capture file</a></h4>
<p>To simplify analysis of the packet capture, it can be helpful to embed the key log from the previous step into the packet capture file itself. <a href="https://www.wireshark.org/docs/man-pages/editcap.html">editcap</a> is a utility for editing packet captures and can perform this embedding:</p>
<pre><code class="language-bash">$ editcap --inject-secrets tls,/var/tmp/keys.log /var/tmp/mycapture.pcap /var/tmp/capturewithkeys.pcapng
</code></pre>
<p>Attach <code>capturewithkeys.pcapng</code> to your issue to aid with debugging. If you skipped step 4, also attach <code>keys.log</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="gso-and-gro"><a class="header" href="#gso-and-gro">GSO and GRO</a></h2>
<p>Generic Segmentation Offload (GSO) and Generic Receive Offload (GRO) are network stack features that can improve the efficiency of transmitting and receiving packets. GSO/GRO are enabled by default in <code>s2n-quic</code> on operating systems that have good support for these features (namely Linux variants). <code>s2n-quic</code> will also automatically disable these features if the operating system emits a socket error indicating they are not supported.</p>
<p>Some operating systems may silently fail when using GSO/GRO, leading to performance degradation. In these cases, <code>s2n-quic</code> will not automatically disable GSO/GRO. You can manually disable GSO/GRO on the IO provider to evaluate if that has a positive impact on performance:</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let io = s2n_quic::provider::io::Default::builder()
    .with_gso(false)? // disable GSO
    .with_gro(false)? // disable GRO
    .build()?;

let mut server = Server::builder()
    .with_io(io)?
    .start()?;
<span class="boring">}</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contributing-guidelines"><a class="header" href="#contributing-guidelines">Contributing Guidelines</a></h1>
<p>Thank you for your interest in contributing to our project. Whether it's a bug report, new feature, correction, or additional
documentation, we greatly value feedback and contributions from our community.</p>
<p>Please read through this document before submitting any issues or pull requests to ensure we have all the necessary
information to effectively respond to your bug report or contribution.</p>
<h2 id="reporting-bugsfeature-requests"><a class="header" href="#reporting-bugsfeature-requests">Reporting Bugs/Feature Requests</a></h2>
<p>We welcome you to use the GitHub issue tracker to report bugs or suggest features.</p>
<p>When filing an issue, please check existing open, or recently closed, issues to make sure somebody else hasn't already
reported the issue. Please try to include as much information as you can. Details like these are incredibly useful:</p>
<ul>
<li>A reproducible test case or series of steps</li>
<li>The version of our code being used</li>
<li>Any modifications you've made relevant to the bug</li>
<li>Anything unusual about your environment or deployment</li>
</ul>
<h2 id="contributing-via-pull-requests"><a class="header" href="#contributing-via-pull-requests">Contributing via Pull Requests</a></h2>
<p>Contributions via pull requests are much appreciated. Before sending us a pull request, please ensure that:</p>
<ol>
<li>You are working against the latest source on the <em>main</em> branch.</li>
<li>You check existing open, and recently merged, pull requests to make sure someone else hasn't addressed the problem already.</li>
<li>You open an issue to discuss any significant work - we would hate for your time to be wasted.</li>
</ol>
<p>To send us a pull request, please:</p>
<ol>
<li>Fork the repository.</li>
<li>Modify the source; please focus on the specific change you are contributing. If you also reformat all the code, it will be hard for us to focus on your change.</li>
<li>Ensure local tests pass.</li>
<li>We follow the <a href="https://www.conventionalcommits.org/en/v1.0.0/">Conventional Commits</a> guidance for commit messages and pull request titles.</li>
<li>Send us a pull request and answer the default questions in the pull request interface.</li>
<li>Pay attention to any automated CI failures reported in the pull request, and stay involved in the conversation.</li>
</ol>
<p>GitHub provides additional document on <a href="https://help.github.com/articles/fork-a-repo/">forking a repository</a> and
<a href="https://help.github.com/articles/creating-a-pull-request/">creating a pull request</a>.</p>
<h2 id="finding-contributions-to-work-on"><a class="header" href="#finding-contributions-to-work-on">Finding contributions to work on</a></h2>
<p>Looking at the existing issues is a great way to find something to contribute on. As our projects, by default, use the default GitHub issue labels (enhancement/bug/duplicate/help wanted/invalid/question/wontfix), looking at any 'help wanted' issues is a great place to start.</p>
<h2 id="code-of-conduct"><a class="header" href="#code-of-conduct">Code of Conduct</a></h2>
<p>This project has adopted the <a href="https://aws.github.io/code-of-conduct">Amazon Open Source Code of Conduct</a>.
For more information see the <a href="https://aws.github.io/code-of-conduct-faq">Code of Conduct FAQ</a> or contact
opensource-codeofconduct@amazon.com with any additional questions or comments.</p>
<h2 id="security-issue-notifications"><a class="header" href="#security-issue-notifications">Security issue notifications</a></h2>
<p>If you discover a potential security issue in s2n-quic we ask that you notify
AWS Security via our <a href="http://aws.amazon.com/security/vulnerability-reporting/">vulnerability reporting page</a>. Please do <strong>not</strong> create a public github issue.</p>
<p>If you package or distribute s2n-quic, or use s2n-quic as part of a large multi-user service, you may be eligible for pre-notification of future s2n-quic releases. Please contact s2n-pre-notification@amazon.com.</p>
<h2 id="licensing"><a class="header" href="#licensing">Licensing</a></h2>
<p><code>s2n-quic</code> source code and documentation is released under the <a href="https://aws.amazon.com/apache-2-0">Apache 2.0 License</a>. We will ask you to confirm the licensing of your contribution.</p>
<p>We may ask you to sign a <a href="http://en.wikipedia.org/wiki/Contributor_License_Agreement">Contributor License Agreement (CLA)</a> for larger changes.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="setup"><a class="header" href="#setup">Setup</a></h1>
<h3 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h3>
<ul>
<li>GCC / clang (some CC). Installation of these items depends on your package manager.</li>
<li>Install <a href="https://rustup.rs/">rustup</a></li>
</ul>
<pre><code class="language-sh"># Install components to test and analyze code
rustup component add rustfmt clippy rust-analysis

# Install the nightly toolchain for testing
rustup toolchain install nightly
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="s2n-quic-continuous-integration"><a class="header" href="#s2n-quic-continuous-integration">s2n-quic Continuous Integration</a></h1>
<p><code>s2n-quic</code> executes a comprehensive suite of tests, linters, benchmarks, simulations and other checks on <a href="https://github.com/aws/s2n-quic/actions/workflows/ci.yml?query=event%3Apull_request">each pull request</a> and merge into <a href="https://github.com/aws/s2n-quic/actions/workflows/ci.yml?query=branch%3Amain">main</a>. Information about these checks is provided below.</p>
<h2 id="tests"><a class="header" href="#tests">Tests</a></h2>
<p><code>s2n-quic</code> defines many tests that can be executed with <code>cargo test</code>. These tests, described below, are executed across a variety of operating systems, architectures, and Rust versions.</p>
<h4 id="unit-tests"><a class="header" href="#unit-tests">Unit Tests</a></h4>
<p>Unit tests validate the expected behavior of individual components of <code>s2n-quic</code>. Typically, unit tests will be located in a <code>tests</code> module at the end of the file being tested. When there are a significant number of unit test functions for given component, the <code>tests</code> module may be located in a separate file.</p>
<h4 id="integration-tests"><a class="header" href="#integration-tests">Integration Tests</a></h4>
<p><code>s2n-quic</code> integration tests use the public API to validate the end-to-end behavior of the library under specific scenarios and configurations. Integration tests are located in the top-level <code>s2n-quic</code> crate, in the <a href="https://github.com/aws/s2n-quic/tree/main/quic/s2n-quic/src/tests">tests module</a>.</p>
<h4 id="snapshot-tests"><a class="header" href="#snapshot-tests">Snapshot Tests</a></h4>
<p>Snapshot tests use <a href="https://crates.io/crates/insta">insta</a> to assert complex output remains consistent with expected references values. In <code>s2n-quic</code>, snapshot tests are typically constructed in one of two ways:</p>
<ul>
<li>using the <code>insta::assert_debug_snapshot</code> macro to compare the <code>Debug</code> representation of an instance to the snapshot</li>
<li>using the <code>event::testing::Publisher::snapshot()</code> event publisher to assert against a snapshot of events emitted by the <code>s2n-quic</code> <a href="https://docs.rs/s2n-quic/latest/s2n_quic/provider/event/trait.Event.html">event framework</a></li>
</ul>
<h4 id="property-tests"><a class="header" href="#property-tests">Property Tests</a></h4>
<p>Property tests assert that specific properties of the output of functions and components are upheld under a variety of inputs. <code>s2n-quic</code> uses the <a href="https://camshaft.github.io/bolero/introduction.html">Bolero property-testing framework</a> to execute property-testing with multiple fuzzing engines as well as the <a href="https://model-checking.github.io/kani/">Kani Rust Verifier</a>. For more details on how Bolero and Kani are used together in <code>s2n-quic</code>, see the following blog posts from the <a href="https://model-checking.github.io/kani-verifier-blog/">Kani Rust Verifier Blog</a>:</p>
<ul>
<li><a href="https://model-checking.github.io/kani-verifier-blog/2022/10/27/using-kani-with-the-bolero-property-testing-framework.html">From Fuzzing to Proof: Using Kani with the Bolero Property-Testing Framework</a></li>
<li><a href="https://model-checking.github.io/kani-verifier-blog/2023/05/30/how-s2n-quic-uses-kani-to-inspire-confidence.html">How s2n-quic uses Kani to inspire confidence</a></li>
</ul>
<h4 id="fuzz-tests"><a class="header" href="#fuzz-tests">Fuzz Tests</a></h4>
<p>Fuzz tests provide large amounts of varied input data to assert <code>s2n-quic</code> behaves as expected regardless of the input. Fuzz testing in <code>s2n-quic</code> comes in three flavors:</p>
<ul>
<li>Component-level fuzz testing using the <a href="https://camshaft.github.io/bolero/introduction.html">Bolero property-testing framework</a>. These tests generate a corpus of inputs that is included in the <code>s2n-quic</code> repository to allow the fuzz tests to be replayed when executing <code>cargo test</code>.</li>
<li>End-to-end QUIC protocol-level fuzzing using <a href="https://github.com/aws/s2n-quic/blob/main/scripts/quic-attack/README.md">quic-attack</a>. <code>quic-attack</code> is a collection of features that collectively turn <code>s2n-quic</code> into an online QUIC protocol fuzzer. It allows incoming and outgoing datagrams and packets, as well as the port number on incoming datagrams, to be intercepted and manipulated.</li>
<li>UDP protocol-level fuzzing using <a href="https://github.com/aws/s2n-quic/tree/main/tools/udp-attack">udp-attack</a>. <code>udp-attack</code> generates random UDP packets and transmits them to <code>s2n-quic</code> to catch issues with packet handling.</li>
</ul>
<h4 id="concurrency-permutation-tests"><a class="header" href="#concurrency-permutation-tests">Concurrency Permutation Tests</a></h4>
<p><a href="https://crates.io/crates/loom">loom</a> is used to validate the behavior of concurrent code in <code>s2n-quic</code>. <code>loom</code> executes concurrent code using a simulation of the operating system scheduler and Rust memory model to evaluate concurrent code under all possible thread interleavings.</p>
<h2 id="interoperability"><a class="header" href="#interoperability">Interoperability</a></h2>
<p>The <a href="https://github.com/marten-seemann/quic-interop-runner">quic-interop-runner</a> defines a suite of test cases that ensure compatibility between QUIC implementations. <code>s2n-quic</code> publishes <a href="https://dnglbrstg7yg.cloudfront.net/latest/interop/index.html">a report</a> with the results.</p>
<h2 id="compliance"><a class="header" href="#compliance">Compliance</a></h2>
<p><code>s2n-quic</code> annotates source code with inline references to requirements in <a href="https://www.ietf.org/process/rfcs/">IETF RFC</a> specifications. <a href="https://github.com/awslabs/duvet">Duvet</a> is used to generate <a href="https://dnglbrstg7yg.cloudfront.net/latest/compliance.html">a report</a>, which makes it easy to track compliance with each requirement.</p>
<h2 id="simulations"><a class="header" href="#simulations">Simulations</a></h2>
<p>A Monte Carlo simulation tool is used to execute thousands of randomized simulations of <code>s2n-quic</code> that vary one or more network variables, such as bandwidth, jitter, and round trip time. The <a href="https://dnglbrstg7yg.cloudfront.net/latest/sim/index.html">report output</a> provides a visual representation of the relationship between the input variables and overall performance.</p>
<p>A loss recovery simulation tool plots the growth of the congestion window over time under various simulated loss scenarios and publishes the results in <a href="https://dnglbrstg7yg.cloudfront.net/latest/recovery-simulations/index.html">a report</a> to visualize changes to the congestion control algorithm.</p>
<h2 id="performance--efficiency-profiling"><a class="header" href="#performance--efficiency-profiling">Performance &amp; Efficiency Profiling</a></h2>
<p><a href="https://www.brendangregg.com/flamegraphs.html">Flame graphs</a> are generated and published in a <a href="https://dnglbrstg7yg.cloudfront.net/latest/perf/index.html">report</a> to visualize stack traces produced under a variety of data transfer scenarios.</p>
<p><a href="https://crates.io/crates/dhat">dhat</a> performs heap profiling and publishes the results in <a href="https://dnglbrstg7yg.cloudfront.net/dhat/dh_view.html?url=/latest/dhat/dhat-heap.json">a report</a>.</p>
<h2 id="clippy"><a class="header" href="#clippy">Clippy</a></h2>
<p><a href="https://github.com/rust-lang/rust-clippy">clippy</a> is a rust linter which catches common mistakes.</p>
<h2 id="rustfmt"><a class="header" href="#rustfmt">Rustfmt</a></h2>
<p><a href="https://github.com/rust-lang/rustfmt">rustfmt</a> ensures code is consistently formatted.</p>
<h2 id="miri"><a class="header" href="#miri">Miri</a></h2>
<p><a href="https://github.com/rust-lang/miri">Miri</a> detects <a href="https://doc.rust-lang.org/reference/behavior-considered-undefined.html">undefined behavior</a> and memory leaks.</p>
<h2 id="code-coverage"><a class="header" href="#code-coverage">Code Coverage</a></h2>
<p><a href="https://llvm.org/docs/CommandGuide/llvm-cov.html">LLVM source-based code coverage</a> measures how much of <code>s2n-quic</code> code is executed by tests. <code>s2n-quic</code> publishes <a href="https://dnglbrstg7yg.cloudfront.net/latest/coverage/index.html">a report</a> with the results.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="kani"><a class="header" href="#kani">Kani</a></h1>
<p><code>s2n-quic</code> uses the <a href="https://github.com/model-checking/kani">Kani Rust Verifier</a> tool for verifying properties throughout various places in the codebase. The Kani test harnesses are written using <a href="https://github.com/camshaft/bolero/">bolero</a>, which is also capable of running them as concrete tests.</p>
<h2 id="getting-started"><a class="header" href="#getting-started">Getting started</a></h2>
<p>First, you will need make sure you install <code>Rust</code> and <code>Kani</code> on your system.</p>
<h3 id="install-rust"><a class="header" href="#install-rust">Install Rust</a></h3>
<p>The easiest way to install Rust is via <a href="https://rustup.rs/">rustup</a>. Otherwise, check your system's package manager for recommended installation methods.</p>
<h3 id="install-kani"><a class="header" href="#install-kani">Install Kani</a></h3>
<p>Kani is installed with <code>cargo</code>:</p>
<pre><code class="language-sh">$ cargo install kani-verifier
$ cargo-kani setup
</code></pre>
<h3 id="running-kani-proofs"><a class="header" href="#running-kani-proofs">Running Kani proofs</a></h3>
<p>After installing <code>Rust</code> and <code>Kani</code>, you can run the <code>s2n-quic</code> proof harnesses. These are currently all located in the <code>s2n-quic-core</code> crate:</p>
<pre><code class="language-sh">$ cd quic/s2n-quic-core
$ cargo kani --tests
</code></pre>
<h3 id="listing-kani-proofs"><a class="header" href="#listing-kani-proofs">Listing Kani proofs</a></h3>
<p>You can find all of the kani harnesses by searching for <code>kani::proof</code></p>
<pre><code class="language-sh">$ cd quic/s2n-quic-core
$ grep -Rn 'kani::proof' .

&lt; LIST OF LOCATIONS WITH KANI PROOFS &gt;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="async-client-hello-callback"><a class="header" href="#async-client-hello-callback">Async client hello callback</a></h1>
<pre><code class="language-rs">#[tokio::main]
async fn main() -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
    let client = Client::builder()
        .with_tls(CERT_PEM)?
        .with_io("0.0.0.0:0")?
        .start()?;

    let addr: SocketAddr = "127.0.0.1:4433".parse()?;
    let connect = Connect::new(addr).with_server_name("localhost");
    let mut connection = client.connect(connect).await?;

    // ensure the connection doesn't time out with inactivity
    connection.keep_alive(true)?;

    // open a new stream and split the receiving and sending sides
    let stream = connection.open_bidirectional_stream().await?;
    let (mut receive_stream, mut send_stream) = stream.split();

    // spawn a task that copies responses from the server to stdout
    tokio::spawn(async move {
        let mut stdout = tokio::io::stdout();
        let _ = tokio::io::copy(&amp;mut receive_stream, &amp;mut stdout).await;
    });

    // copy data from stdin and send it to the server
    let mut stdin = tokio::io::stdin();
    tokio::io::copy(&amp;mut stdin, &amp;mut send_stream).await?;

    Ok(())
}
</code></pre>
<pre><code class="language-rs">// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
// SPDX-License-Identifier: Apache-2.0

use moka::sync::Cache;
use rand::{distributions::WeightedIndex, prelude::*};
use s2n_quic::{
    provider::tls::s2n_tls::{
        callbacks::{ClientHelloCallback, ConfigResolver, ConnectionFuture},
        config::Config,
        connection::Connection,
        error::Error as S2nError,
    },
    Server,
};
use std::{error::Error, fmt::Display, pin::Pin, sync::Arc, time::Duration};
use tokio::{fs, sync::OnceCell};

/// NOTE: this certificate is to be used for demonstration purposes only!
pub static CERT_PEM_PATH: &amp;str = concat!(
    env!("CARGO_MANIFEST_DIR"),
    "/../../quic/s2n-quic-core/certs/cert.pem"
);
/// NOTE: this certificate is to be used for demonstration purposes only!
pub static KEY_PEM_PATH: &amp;str = concat!(
    env!("CARGO_MANIFEST_DIR"),
    "/../../quic/s2n-quic-core/certs/key.pem"
);

type Sni = String;

// A Config cache associated with as SNI (server name indication).
//
// Implements ClientHelloCallback, loading the certificates asynchronously,
// and caching the s2n_tls::config::Config for subsequent calls with the
// same SNI.
//
// An SNI, indicates which hostname the client is attempting to connect to.
// Some deployments could require configuring the s2n_tls::config::Config
// based on the SNI (certificate).
struct ConfigCache {
    cache: Cache&lt;Sni, Arc&lt;OnceCell&lt;Config&gt;&gt;&gt;,
}

impl ConfigCache {
    fn new() -&gt; Self {
        ConfigCache {
            // store Config for up to 100 unique SNI
            cache: Cache::new(100),
        }
    }
}

impl ClientHelloCallback for ConfigCache {
    fn on_client_hello(
        &amp;self,
        connection: &amp;mut Connection,
    ) -&gt; Result&lt;Option&lt;Pin&lt;Box&lt;dyn ConnectionFuture&gt;&gt;&gt;, S2nError&gt; {
        let sni = connection
            .server_name()
            .ok_or_else(|| S2nError::application(Box::new(CustomError)))?
            .to_string();

        let once_cell_config = self
            .cache
            .get_with(sni.clone(), || Arc::new(OnceCell::new()));
        if let Some(config) = once_cell_config.get() {
            eprintln!("Config already cached for SNI: {}", sni);
            connection.set_config(config.clone())?;
            // return `None` if the Config is already in the cache
            return Ok(None);
        }

        // simulate failure 75% of times and success 25% of the times
        let choices = [true, false];
        let weights = [3, 1];
        let dist = WeightedIndex::new(weights).unwrap();

        let fut = async move {
            let fut = once_cell_config.get_or_try_init(|| async {
                let simulated_network_call_failed = choices[dist.sample(&amp;mut thread_rng())];

                if simulated_network_call_failed {
                    eprintln!("simulated network call failed");
                    return Err(S2nError::application(Box::new(CustomError)));
                }

                eprintln!("resolving certificate for SNI: {}", sni);

                // load the cert and key file asynchronously.
                let (cert, key) = {
                    // the SNI can be used to load the appropriate cert file
                    let _sni = sni;
                    let cert = fs::read_to_string(CERT_PEM_PATH)
                        .await
                        .map_err(|_| S2nError::application(Box::new(CustomError)))?;
                    let key = fs::read_to_string(KEY_PEM_PATH)
                        .await
                        .map_err(|_| S2nError::application(Box::new(CustomError)))?;
                    (cert, key)
                };

                // sleep(async tokio task which doesn't block thread) to mimic delay
                tokio::time::sleep(Duration::from_secs(3)).await;

                let config = s2n_quic::provider::tls::s2n_tls::Server::builder()
                    .with_certificate(cert, key)?
                    .build()?
                    .into();
                Ok(config)
            });
            fut.await.cloned()
        };

        // return `Some(ConnectionFuture)` if the Config wasn't found in the
        // cache and we need to load it asynchronously
        Ok(Some(Box::pin(ConfigResolver::new(fut))))
    }
}

#[tokio::main]
async fn main() -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
    let tls = s2n_quic::provider::tls::s2n_tls::Server::builder()
        .with_client_hello_handler(ConfigCache::new())?
        .build()?;

    let mut server = Server::builder()
        .with_tls(tls)?
        .with_io("127.0.0.1:4433")?
        .start()?;

    while let Some(mut connection) = server.accept().await {
        // spawn a new task for the connection
        tokio::spawn(async move {
            eprintln!("Connection accepted from {:?}", connection.remote_addr());

            while let Ok(Some(mut stream)) = connection.accept_bidirectional_stream().await {
                // spawn a new task for the stream
                tokio::spawn(async move {
                    eprintln!("Stream opened from {:?}", stream.connection().remote_addr());

                    // echo any data back to the stream
                    while let Ok(Some(data)) = stream.receive().await {
                        stream.send(data).await.expect("stream should be open");
                    }
                });
            }
        });
    }

    Ok(())
}

#[derive(Debug)]
struct CustomError;

impl Display for CustomError {
    fn fmt(&amp;self, f: &amp;mut std::fmt::Formatter&lt;'_&gt;) -&gt; std::fmt::Result {
        write!(f, "custom error")?;
        Ok(())
    }
}

impl Error for CustomError {}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="custom-congestion-controller"><a class="header" href="#custom-congestion-controller">Custom Congestion Controller</a></h1>
<p>This folder contains an example of implementing and configuring a custom congestion controller in <code>s2n-quic</code>. <code>s2n-quic</code> includes <a href="https://www.rfc-editor.org/rfc/rfc8312">CUBIC</a> and <a href="https://datatracker.ietf.org/doc/html/draft-cardwell-iccrg-bbr-congestion-control">BBRv2</a> congestion controller implementations, but you may
implement the <code>CongestionController</code> trait, found in <a href="examples/../../quic/s2n-quic-core/src/recovery/congestion_controller.rs">congestion_controller.rs</a>, to provide your own.</p>
<h1 id="set-up"><a class="header" href="#set-up">Set-up</a></h1>
<p>The <code>CongestionController</code> trait is considered unstable and may be subject to change in a future release. In order to build it you must
add this line to your Cargo.toml file:</p>
<pre><code class="language-toml">[dependencies]
s2n-quic = { version = "1", features = ["unstable-congestion-controller"]}
</code></pre>
<h2 id="example"><a class="header" href="#example">Example</a></h2>
<pre><code class="language-rs">#[tokio::main]
async fn main() -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
    // Build an `s2n_quic::Server`
    let mut server = Server::builder()
        .with_tls((CERT_PEM, KEY_PEM))?
        .with_io("127.0.0.1:4433")?
        // Specify the custom congestion controller endpoint defined in `custom-congestion-controller/src/lib.rs`
        .with_congestion_controller(MyCongestionControllerEndpoint::default())?
        .start()?;

    while let Some(mut connection) = server.accept().await {
        // spawn a new task for the connection
        tokio::spawn(async move {
            eprintln!("Connection accepted from {:?}", connection.remote_addr());

            while let Ok(Some(mut stream)) = connection.accept_bidirectional_stream().await {
                // spawn a new task for the stream
                tokio::spawn(async move {
                    eprintln!("Stream opened from {:?}", stream.connection().remote_addr());

                    // echo any data back to the stream
                    while let Ok(Some(data)) = stream.receive().await {
                        stream.send(data).await.expect("stream should be open");
                    }
                });
            }
        });
    }

    Ok(())
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
