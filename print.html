<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>s2n-quic Guide</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">User Guide</li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Introduction</div></li><li class="chapter-item expanded "><a href="user-guide/installation.html"><strong aria-hidden="true">3.</strong> Installation</a></li><li class="chapter-item expanded affix "><li class="part-title">Developer Guide</li><li class="chapter-item expanded "><a href="dev-guide.html"><strong aria-hidden="true">4.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="dev-guide/setup.html"><strong aria-hidden="true">5.</strong> Setup</a></li><li class="chapter-item expanded "><a href="dev-guide/ci.html"><strong aria-hidden="true">6.</strong> Continuous Integration</a></li><li class="chapter-item expanded "><a href="dev-guide/kani.html"><strong aria-hidden="true">7.</strong> Kani</a></li><li class="chapter-item expanded affix "><li class="part-title">Examples</li><li class="chapter-item expanded "><a href="examples/async-client-hello-callback.html"><strong aria-hidden="true">8.</strong> Async client hello callback</a></li><li class="chapter-item expanded "><a href="examples/custom-congestion-controller.html"><strong aria-hidden="true">9.</strong> Custom congestion controller</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.</strong> dos mitigation</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.</strong> Echo</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.</strong> Event framework</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.</strong> Jumbo frame</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.</strong> rustls mtls</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">15.</strong> rustls provider</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">16.</strong> turmoil provider</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">17.</strong> Unreliable datagram</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">s2n-quic Guide</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/aws/s2n-quic" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p><code>s2n-quic</code> is a Rust implementation of the <a href="https://quicwg.org/">IETF QUIC protocol</a>.</p>
<h3 id="user-guide"><a class="header" href="#user-guide">User Guide</a></h3>
<p>If you are wanting to use <code>s2n-quic</code> in your application, you can find documentation on how to do that in the <a href="user-guide.html">user guide</a>.</p>
<h3 id="developer-guide"><a class="header" href="#developer-guide">Developer Guide</a></h3>
<p>If you are wanting to contribute and/or learn about implementation details of <code>s2n-quic</code>, please read the <a href="dev-guide.html">developer guide</a>.</p>
<h2 id="license"><a class="header" href="#license">License</a></h2>
<p><code>s2n-quic</code> source code and documentation is released under the <a href="https://aws.amazon.com/apache-2-0">Apache 2.0 License</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contributing-guidelines"><a class="header" href="#contributing-guidelines">Contributing Guidelines</a></h1>
<p>Thank you for your interest in contributing to our project. Whether it's a bug report, new feature, correction, or additional
documentation, we greatly value feedback and contributions from our community.</p>
<p>Please read through this document before submitting any issues or pull requests to ensure we have all the necessary
information to effectively respond to your bug report or contribution.</p>
<h2 id="reporting-bugsfeature-requests"><a class="header" href="#reporting-bugsfeature-requests">Reporting Bugs/Feature Requests</a></h2>
<p>We welcome you to use the GitHub issue tracker to report bugs or suggest features.</p>
<p>When filing an issue, please check existing open, or recently closed, issues to make sure somebody else hasn't already
reported the issue. Please try to include as much information as you can. Details like these are incredibly useful:</p>
<ul>
<li>A reproducible test case or series of steps</li>
<li>The version of our code being used</li>
<li>Any modifications you've made relevant to the bug</li>
<li>Anything unusual about your environment or deployment</li>
</ul>
<h2 id="contributing-via-pull-requests"><a class="header" href="#contributing-via-pull-requests">Contributing via Pull Requests</a></h2>
<p>Contributions via pull requests are much appreciated. Before sending us a pull request, please ensure that:</p>
<ol>
<li>You are working against the latest source on the <em>main</em> branch.</li>
<li>You check existing open, and recently merged, pull requests to make sure someone else hasn't addressed the problem already.</li>
<li>You open an issue to discuss any significant work - we would hate for your time to be wasted.</li>
</ol>
<p>To send us a pull request, please:</p>
<ol>
<li>Fork the repository.</li>
<li>Modify the source; please focus on the specific change you are contributing. If you also reformat all the code, it will be hard for us to focus on your change.</li>
<li>Ensure local tests pass.</li>
<li>We follow the <a href="https://www.conventionalcommits.org/en/v1.0.0/">Conventional Commits</a> guidance for commit messages and pull request titles.</li>
<li>Send us a pull request and answer the default questions in the pull request interface.</li>
<li>Pay attention to any automated CI failures reported in the pull request, and stay involved in the conversation.</li>
</ol>
<p>GitHub provides additional document on <a href="https://help.github.com/articles/fork-a-repo/">forking a repository</a> and
<a href="https://help.github.com/articles/creating-a-pull-request/">creating a pull request</a>.</p>
<h2 id="finding-contributions-to-work-on"><a class="header" href="#finding-contributions-to-work-on">Finding contributions to work on</a></h2>
<p>Looking at the existing issues is a great way to find something to contribute on. As our projects, by default, use the default GitHub issue labels (enhancement/bug/duplicate/help wanted/invalid/question/wontfix), looking at any 'help wanted' issues is a great place to start.</p>
<h2 id="code-of-conduct"><a class="header" href="#code-of-conduct">Code of Conduct</a></h2>
<p>This project has adopted the <a href="https://aws.github.io/code-of-conduct">Amazon Open Source Code of Conduct</a>.
For more information see the <a href="https://aws.github.io/code-of-conduct-faq">Code of Conduct FAQ</a> or contact
opensource-codeofconduct@amazon.com with any additional questions or comments.</p>
<h2 id="security-issue-notifications"><a class="header" href="#security-issue-notifications">Security issue notifications</a></h2>
<p>If you discover a potential security issue in s2n-quic we ask that you notify
AWS Security via our <a href="http://aws.amazon.com/security/vulnerability-reporting/">vulnerability reporting page</a>. Please do <strong>not</strong> create a public github issue.</p>
<p>If you package or distribute s2n-quic, or use s2n-quic as part of a large multi-user service, you may be eligible for pre-notification of future s2n-quic releases. Please contact s2n-pre-notification@amazon.com.</p>
<h2 id="licensing"><a class="header" href="#licensing">Licensing</a></h2>
<p><code>s2n-quic</code> source code and documentation is released under the <a href="https://aws.amazon.com/apache-2-0">Apache 2.0 License</a>. We will ask you to confirm the licensing of your contribution.</p>
<p>We may ask you to sign a <a href="http://en.wikipedia.org/wiki/Contributor_License_Agreement">Contributor License Agreement (CLA)</a> for larger changes.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="setup"><a class="header" href="#setup">Setup</a></h1>
<h3 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h3>
<ul>
<li>GCC / clang (some CC). Installation of these items depends on your package manager.</li>
<li>Install <a href="https://rustup.rs/">rustup</a></li>
</ul>
<pre><code class="language-sh"># Install components to test and analyze code
rustup component add rustfmt clippy rust-analysis

# Install the nightly toolchain for testing
rustup toolchain install nightly
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="s2n-quic-continuous-integration"><a class="header" href="#s2n-quic-continuous-integration">s2n-quic Continuous Integration</a></h1>
<p><code>s2n-quic</code> runs many tests on <a href="https://github.com/aws/s2n-quic/actions/workflows/ci.yml?query=event%3Apull_request">each pull request</a> and merge into <a href="https://github.com/aws/s2n-quic/actions/workflows/ci.yml?query=branch%3Amain">main</a>. This ensures each change is thoroughly tested.</p>
<h2 id="tests"><a class="header" href="#tests">Tests</a></h2>
<p><code>s2n-quic</code> defines many tests that can be executed with <code>cargo test</code>. These tests include unit, integration, snapshot, property, and fuzz tests.</p>
<h2 id="clippy"><a class="header" href="#clippy">Clippy</a></h2>
<p><a href="https://github.com/rust-lang/rust-clippy">clippy</a> is a rust linter which catches common mistakes.</p>
<h2 id="rustfmt"><a class="header" href="#rustfmt">Rustfmt</a></h2>
<p><a href="https://github.com/rust-lang/rustfmt">rustfmt</a> ensures code is consistently formatted.</p>
<h2 id="interop"><a class="header" href="#interop">Interop</a></h2>
<p>The <a href="https://github.com/marten-seemann/quic-interop-runner">quic-interop-runner</a> defines many test cases that ensure many of the 3rd party QUIC implementations are compatible. <code>s2n-quic</code> publishes <a href="https://dnglbrstg7yg.cloudfront.net/08c33571ee8679775e810303f65c96c1d48e270d/interop/index.html">a report</a> with the results.</p>
<h2 id="compliance"><a class="header" href="#compliance">Compliance</a></h2>
<p><code>s2n-quic</code> annotates source code with inline references to requirements in design documents and RFCs. <a href="https://dnglbrstg7yg.cloudfront.net/08c33571ee8679775e810303f65c96c1d48e270d/compliance.html#/">A report</a> is then generated, which makes it easy to track compliance with each requirement.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="kani"><a class="header" href="#kani">Kani</a></h1>
<p><code>s2n-quic</code> uses the <a href="https://github.com/model-checking/kani">Kani Rust Verifier</a> tool for verifying properties throughout various places in the codebase. The Kani test harnesses are written using <a href="https://github.com/camshaft/bolero/">bolero</a>, which is also capable of running them as concrete tests.</p>
<h2 id="getting-started"><a class="header" href="#getting-started">Getting started</a></h2>
<p>First, you will need make sure you install <code>Rust</code> and <code>Kani</code> on your system.</p>
<h3 id="install-rust"><a class="header" href="#install-rust">Install Rust</a></h3>
<p>The easiest way to install Rust is via <a href="https://rustup.rs/">rustup</a>. Otherwise, check your system's package manager for recommended installation methods.</p>
<h3 id="install-kani"><a class="header" href="#install-kani">Install Kani</a></h3>
<p>Kani is installed with <code>cargo</code>:</p>
<pre><code class="language-sh">$ cargo install kani-verifier
$ cargo-kani setup
</code></pre>
<h3 id="running-kani-proofs"><a class="header" href="#running-kani-proofs">Running Kani proofs</a></h3>
<p>After installing <code>Rust</code> and <code>Kani</code>, you can run the <code>s2n-quic</code> proof harnesses. These are currently all located in the <code>s2n-quic-core</code> crate:</p>
<pre><code class="language-sh">$ cd quic/s2n-quic-core
$ cargo kani --tests
</code></pre>
<h3 id="listing-kani-proofs"><a class="header" href="#listing-kani-proofs">Listing Kani proofs</a></h3>
<p>You can find all of the kani harnesses by searching for <code>kani::proof</code></p>
<pre><code class="language-sh">$ cd quic/s2n-quic-core
$ grep -Rn 'kani::proof' .

&lt; LIST OF LOCATIONS WITH KANI PROOFS &gt;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="async-client-hello-callback"><a class="header" href="#async-client-hello-callback">Async client hello callback</a></h1>
<pre><code class="language-rs">#[tokio::main]
async fn main() -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
    let client = Client::builder()
        .with_tls(CERT_PEM)?
        .with_io(&quot;0.0.0.0:0&quot;)?
        .start()?;

    let addr: SocketAddr = &quot;127.0.0.1:4433&quot;.parse()?;
    let connect = Connect::new(addr).with_server_name(&quot;localhost&quot;);
    let mut connection = client.connect(connect).await?;

    // ensure the connection doesn't time out with inactivity
    connection.keep_alive(true)?;

    // open a new stream and split the receiving and sending sides
    let stream = connection.open_bidirectional_stream().await?;
    let (mut receive_stream, mut send_stream) = stream.split();

    // spawn a task that copies responses from the server to stdout
    tokio::spawn(async move {
        let mut stdout = tokio::io::stdout();
        let _ = tokio::io::copy(&amp;mut receive_stream, &amp;mut stdout).await;
    });

    // copy data from stdin and send it to the server
    let mut stdin = tokio::io::stdin();
    tokio::io::copy(&amp;mut stdin, &amp;mut send_stream).await?;

    Ok(())
}
</code></pre>
<pre><code class="language-rs">// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
// SPDX-License-Identifier: Apache-2.0

use moka::sync::Cache;
use rand::{distributions::WeightedIndex, prelude::*};
use s2n_quic::{
    provider::tls::s2n_tls::{
        s2n_tls::{
            callbacks::{ConfigResolver, ConnectionFuture},
            config::Config,
            error::Error as S2nError,
        },
        ClientHelloCallback, Connection,
    },
    Server,
};
use std::{error::Error, fmt::Display, pin::Pin, sync::Arc, time::Duration};
use tokio::{fs, sync::OnceCell};

/// NOTE: this certificate is to be used for demonstration purposes only!
pub static CERT_PEM_PATH: &amp;str = concat!(
    env!(&quot;CARGO_MANIFEST_DIR&quot;),
    &quot;/../../quic/s2n-quic-core/certs/cert.pem&quot;
);
/// NOTE: this certificate is to be used for demonstration purposes only!
pub static KEY_PEM_PATH: &amp;str = concat!(
    env!(&quot;CARGO_MANIFEST_DIR&quot;),
    &quot;/../../quic/s2n-quic-core/certs/key.pem&quot;
);

type Sni = String;

// A Config cache associated with as SNI (server name indication).
//
// Implements ClientHelloCallback, loading the certificates asynchronously,
// and caching the s2n_tls::config::Config for subsequent calls with the
// same SNI.
//
// An SNI, indicates which hostname the client is attempting to connect to.
// Some deployments could require configuring the s2n_tls::config::Config
// based on the SNI (certificate).
struct ConfigCache {
    cache: Cache&lt;Sni, Arc&lt;OnceCell&lt;Config&gt;&gt;&gt;,
}

impl ConfigCache {
    fn new() -&gt; Self {
        ConfigCache {
            // store Config for up to 100 unique SNI
            cache: Cache::new(100),
        }
    }
}

impl ClientHelloCallback for ConfigCache {
    fn on_client_hello(
        &amp;self,
        connection: &amp;mut Connection,
    ) -&gt; Result&lt;Option&lt;Pin&lt;Box&lt;dyn ConnectionFuture&gt;&gt;&gt;, S2nError&gt; {
        let sni = connection
            .server_name()
            .ok_or_else(|| S2nError::application(Box::new(CustomError)))?
            .to_string();

        let once_cell_config = self
            .cache
            .get_with(sni.clone(), || Arc::new(OnceCell::new()));
        if let Some(config) = once_cell_config.get() {
            eprintln!(&quot;Config already cached for SNI: {}&quot;, sni);
            connection.set_config(config.clone())?;
            // return `None` if the Config is already in the cache
            return Ok(None);
        }

        // simulate failure 75% of times and success 25% of the times
        let choices = [true, false];
        let weights = [3, 1];
        let dist = WeightedIndex::new(weights).unwrap();
        let mut rng = thread_rng();

        let fut = async move {
            let fut = once_cell_config.get_or_try_init(|| async {
                let simulated_network_call_failed = choices[dist.sample(&amp;mut rng)];

                if simulated_network_call_failed {
                    eprintln!(&quot;simulated network call failed&quot;);
                    return Err(S2nError::application(Box::new(CustomError)));
                }

                eprintln!(&quot;resolving certificate for SNI: {}&quot;, sni);

                // load the cert and key file asynchronously.
                let (cert, key) = {
                    // the SNI can be used to load the appropriate cert file
                    let _sni = sni;
                    let cert = fs::read_to_string(CERT_PEM_PATH)
                        .await
                        .map_err(|_| S2nError::application(Box::new(CustomError)))?;
                    let key = fs::read_to_string(KEY_PEM_PATH)
                        .await
                        .map_err(|_| S2nError::application(Box::new(CustomError)))?;
                    (cert, key)
                };

                // sleep(async tokio task which doesn't block thread) to mimic delay
                tokio::time::sleep(Duration::from_secs(3)).await;

                let config = s2n_quic::provider::tls::s2n_tls::Server::builder()
                    .with_certificate(cert, key)?
                    .build()?
                    .into();
                Ok(config)
            });
            fut.await.map(|config| config.clone())
        };

        // return `Some(ConnectionFuture)` if the Config wasn't found in the
        // cache and we need to load it asynchronously
        Ok(Some(Box::pin(ConfigResolver::new(fut))))
    }
}

#[tokio::main]
async fn main() -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
    let tls = s2n_quic::provider::tls::s2n_tls::Server::builder()
        .with_client_hello_handler(ConfigCache::new())?
        .build()?;

    let mut server = Server::builder()
        .with_tls(tls)?
        .with_io(&quot;127.0.0.1:4433&quot;)?
        .start()?;

    while let Some(mut connection) = server.accept().await {
        // spawn a new task for the connection
        tokio::spawn(async move {
            eprintln!(&quot;Connection accepted from {:?}&quot;, connection.remote_addr());

            while let Ok(Some(mut stream)) = connection.accept_bidirectional_stream().await {
                // spawn a new task for the stream
                tokio::spawn(async move {
                    eprintln!(&quot;Stream opened from {:?}&quot;, stream.connection().remote_addr());

                    // echo any data back to the stream
                    while let Ok(Some(data)) = stream.receive().await {
                        stream.send(data).await.expect(&quot;stream should be open&quot;);
                    }
                });
            }
        });
    }

    Ok(())
}

#[derive(Debug)]
struct CustomError;

impl Display for CustomError {
    fn fmt(&amp;self, f: &amp;mut std::fmt::Formatter&lt;'_&gt;) -&gt; std::fmt::Result {
        write!(f, &quot;custom error&quot;)?;
        Ok(())
    }
}

impl Error for CustomError {}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="custom-congestion-controller"><a class="header" href="#custom-congestion-controller">Custom Congestion Controller</a></h1>
<p>This folder contains an example of implementing and configuring a custom congestion controller in <code>s2n-quic</code>. <code>s2n-quic</code> includes <a href="https://www.rfc-editor.org/rfc/rfc8312">CUBIC</a> and <a href="https://datatracker.ietf.org/doc/html/draft-cardwell-iccrg-bbr-congestion-control">BBRv2</a> congestion controller implementations, but you may
implement the <code>CongestionController</code> trait, found in <a href="examples/../../quic/s2n-quic-core/src/recovery/congestion_controller.rs">congestion_controller.rs</a>, to provide your own.</p>
<h1 id="set-up"><a class="header" href="#set-up">Set-up</a></h1>
<p>The <code>CongestionController</code> trait is considered unstable and may be subject to change in a future release. In order to build it you must pass a compiler flag:</p>
<pre><code class="language-sh">export RUSTFLAGS=&quot;--cfg s2n_quic_unstable&quot;
</code></pre>
<p>and add this line to your Cargo.toml file:</p>
<pre><code class="language-toml">[dependencies]
s2n-quic = { version = &quot;1&quot;, features = [&quot;unstable-congestion-controller&quot;]}
</code></pre>
<h2 id="example"><a class="header" href="#example">Example</a></h2>
<pre><code class="language-rs">#[tokio::main]
async fn main() -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
    // Build an `s2n_quic::Server`
    let mut server = Server::builder()
        .with_tls((CERT_PEM, KEY_PEM))?
        .with_io(&quot;127.0.0.1:4433&quot;)?
        // Specify the custom congestion controller endpoint defined in `custom-congestion-controller/src/lib.rs`
        .with_congestion_controller(MyCongestionControllerEndpoint::default())?
        .start()?;

    while let Some(mut connection) = server.accept().await {
        // spawn a new task for the connection
        tokio::spawn(async move {
            eprintln!(&quot;Connection accepted from {:?}&quot;, connection.remote_addr());

            while let Ok(Some(mut stream)) = connection.accept_bidirectional_stream().await {
                // spawn a new task for the stream
                tokio::spawn(async move {
                    eprintln!(&quot;Stream opened from {:?}&quot;, stream.connection().remote_addr());

                    // echo any data back to the stream
                    while let Ok(Some(data)) = stream.receive().await {
                        stream.send(data).await.expect(&quot;stream should be open&quot;);
                    }
                });
            }
        });
    }

    Ok(())
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
