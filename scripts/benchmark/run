#!/usr/bin/env bash

#
# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0
#

set -e

function ensure_executable() {
  if ! command -v $1 &> /dev/null; then
    echo "$1 needs to be installed"
    exit
  fi
}

ensure_executable "docker-compose"

case "$(uname -s)" in
        Linux)
sudo modprobe ip6table_filter
;;
*)
# TODO possibly add other things for Darwin
;;
esac

ROOT_DIR=$(realpath "$(dirname $0)/../../")
OUTPUT_DIR="${ROOT_DIR}/target/benchmark/results"
mkdir -p OUTPUT_DIR

DOWNLOAD_MB=${1:-10}
UPLOAD_MB=${2:-0}
SCENARIO=${3:-"simple-p2p --delay=15ms --bandwidth=10Mbps --queue=25"}

ROOT_DIR="$ROOT_DIR" \
OUTPUT_DIR="$OUTPUT_DIR" \
DOWNLOAD_B=$(($DOWNLOAD_MB * 1000000)) \
UPLOAD_B=$(($UPLOAD_MB * 1000000)) \
SCENARIO=${SCENARIO} \
docker-compose --file quic/s2n-quic-qns/benchmark/docker-compose.yml up --abort-on-container-exit --timeout 1 sim client server
