#!/usr/bin/env bash

#
# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0
#

set -e

# Setup the s2n-quic docker image
#sudo docker build . --file quic/s2n-quic-qns/benchmark/server/Dockerfile.build --tag awslabs/s2n-quic-qns
sudo docker build . --file quic/s2n-quic-qns/benchmark/client/Dockerfile.build --tag quinn/perf-client

function ensure_executable() {
  if ! command -v $1 &> /dev/null; then
    echo "$1 needs to be installed"
    exit
  fi
}

ensure_executable "docker-compose"
ensure_executable "tshark"

case "$(uname -s)" in
   Linux)
     sudo modprobe ip6table_filter
     ;;
   *)
     # TODO possibly add other things for Darwin
     ;;
esac

SCENARIO="simple-p2p --delay=15ms --bandwidth=10Mbps --queue=25" \
DOWNLOAD_B="10000000" \
UPLOAD_B="0" \
docker-compose --file quic/s2n-quic-qns/benchmark/docker-compose.yml up --abort-on-container-exit --timeout 1 sim client server