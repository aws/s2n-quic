#!/usr/bin/env bash

#
# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0
#

set -e

if ! command -v "inferno-collapse-perf" &> /dev/null; then
  cargo install inferno
fi

if [ ! -f target/perf/quinn/bin/perf_client ]; then
  mkdir -p target/perf/quinn
  cargo +stable install \
    --git https://github.com/quinn-rs/quinn \
    --rev 3f908a2c8c1ec4585212d776fafe536ea17bf2b4 \
    --bin perf_client \
    --root target/perf/quinn \
    --target-dir target/perf/quinn \
    perf
fi

RUSTFLAGS="-g" cargo \
  +stable \
  build \
  --bin s2n-quic-qns \
  --release

