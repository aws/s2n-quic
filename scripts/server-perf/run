#!/usr/bin/env bash

set -e

## get amount of data to receive(dl) and send(up) from s2n server
FILENAME=flame
DL_SIZE=${1:-500MB}
UL_SIZE=${2:-500MB}

## init
DIR=$(mktemp -d -t s2n-quic-perf-XXXXXXXXXX)

./scripts/server-perf/build

mkdir -p ./target/perf

## launch s2n server with perf enabled
sudo echo "starting"
sudo sh -c "perf record \
  --output $DIR/$FILENAME.perf \
  --call-graph dwarf \
 ./target/release/s2n-quic-qns \
  perf \
  server \
  --port 4433" &
SUDO_PID=$!

## note SUDO_PID of s2n server so we can shut it down after test
function stop_server() {
  SHELL_PID=$(ps --ppid $SUDO_PID -o pid=)
  PERF_PID=$(ps --ppid $SHELL_PID -o pid=)
  sudo kill -SIGINT $PERF_PID

  wait $SUDO_PID || true
  if [ ! -z "$1" ]; then
    echo $1
    exit 1
  fi
}

echo "waiting for server to boot"
sleep 3

## launch quic client
echo "executing request"
./scripts/server-perf/client/target/release/perf-client \
  https://localhost:4433 --download $DL_SIZE --upload $UL_SIZE || stop_server "failed to finish the request"

sleep 1
stop_server

## process perf results
sudo perf script \
  --input $DIR/$FILENAME.perf \
  2>/dev/null \
  | inferno-collapse-perf \
  > $DIR/$FILENAME.folded

cat $DIR/$FILENAME.folded \
  | inferno-flamegraph \
  > ./target/perf/$FILENAME.svg

sudo rm -f $DIR/$FILENAME.perf
sudo rm -f $DIR/$FILENAME.folded

echo "flamegraph available in ./target/perf/$FILENAME.svg"
