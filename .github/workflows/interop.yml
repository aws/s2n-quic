on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

name: interop

env:
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10
  RUST_BACKTRACE: 1
  SCCACHE_CACHE_SIZE: 300M
  SCCACHE_DIR: ${{ github.workspace }}/.sccache
  SCCACHE_IDLE_TIMEOUT: 0
  # This kept breaking builds so we're pinning for now. We should do our best to keep
  # up with the changes, though.
  INTEROP_RUNNER_REF: 18a87278621e9bdf166b9e294f4095e213cb4845
  NETWORK_SIMULATOR_REF: sha256:d36e1ffd9369e41e9fd5cb8d2af5fb69d4bfaf1b1983fc538a5a3bf7777af4ba
  IPERF_ENDPOINT_REF: sha256:cb50cc8019d45d9cad5faecbe46a3c21dd5e871949819a5175423755a9045106

jobs:
  env:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.implementations.outputs.matrix }}
    steps:
      - uses: ouzi-dev/commit-status-updater@v1.1.0
        with:
          name: 'interop / report'
          status: 'pending'

      - uses: actions/checkout@v2
        with:
          repository: marten-seemann/quic-interop-runner
          ref: ${{ env.INTEROP_RUNNER_REF }}
          path: quic-interop-runner

      - name: Define implementations
        id: implementations
        working-directory: quic-interop-runner
        run: |
          CLIENTS=$(cat implementations.json \
            | jq -c '[. | to_entries[] | select(.value.role == "both" or .value.role == "client") | {"client": .key, "server": "s2n-quic"}] | sort'
          )
          echo "Clients: $CLIENTS"
          SERVERS=$(cat implementations.json \
            | jq -c '[. | to_entries[] | select(.value.role == "both" or .value.role == "server") | {"client": "s2n-quic", "server": .key}] | sort'
          )
          echo "Servers: $SERVERS"
          # TODO add servers when s2n-quic adds support for client mode
          MATRIX=$(echo "[$CLIENTS]" | jq -c '{"include": . | flatten}')
          echo "Matrix: $MATRIX"
          echo "::set-output name=matrix::$MATRIX"

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions-rs/toolchain@v1
        id: toolchain
        with:
          toolchain: stable
          profile: minimal
          override: true

      - uses: actions/checkout@v2

      - name: Install sccache
        uses: actions-rs/install@v0.1
        with:
          crate: sccache
          use-tool-cache: true
          version: latest

      - name: Generate Cargo.lock
        run: cargo update

      - name: Cache cargo registry
        uses: actions/cache@v2
        continue-on-error: true
        with:
          path: ~/.cargo/registry/cache
          key: ${{ runner.os }}-${{ steps.toolchain.outputs.rustc_hash }}-${{ github.job }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-${{ steps.toolchain.outputs.rustc_hash }}-${{ github.job }}-cargo-registry-

      - name: Cache sccache output
        uses: actions/cache@v2
        continue-on-error: true
        with:
          path: ${{ github.workspace }}/.sccache
          key: ${{ runner.os }}-${{ steps.toolchain.outputs.rustc_hash }}-${{ github.job }}-sccache-${{ hashFiles('**/Cargo.*') }}
          restore-keys: ${{ runner.os }}-${{ steps.toolchain.outputs.rustc_hash }}-${{ github.job }}-sccache-

      - name: Start sccache
        run: sccache --start-server

      - name: Run cargo build
        uses: actions-rs/cargo@v1
        with:
          command: build
          # build in debug to have better stacktraces when things go wrong
          args: --bin s2n-quic-qns
        env:
          RUSTC_WRAPPER: sccache

      - name: Prepare artifact
        run: |
          mkdir -p s2n-quic-qns
          cp target/debug/s2n-quic-qns s2n-quic-qns/
          cp qns/Dockerfile s2n-quic-qns/
          cp qns/run_endpoint.sh s2n-quic-qns/

      - uses: actions/upload-artifact@v2
        with:
          name: s2n-quic-qns
          path: s2n-quic-qns/

      - name: Stop sccache
        run: sccache --stop-server

  interop:
    runs-on: ubuntu-latest
    needs: [env, build]
    strategy:
      matrix: ${{ fromJson(needs.env.outputs.matrix) }}
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: s2n-quic-qns
          path: s2n-quic-qns/

      - name: Run docker build
        working-directory: s2n-quic-qns
        run: |
          docker build . --file Dockerfile --tag awslabs/s2n-quic-qns

      - uses: actions/checkout@v2
        with:
          repository: marten-seemann/quic-interop-runner
          ref: ${{ env.INTEROP_RUNNER_REF }}
          path: quic-interop-runner

      - name: Patch implementations.json
        working-directory: quic-interop-runner
        run: |
          mv implementations.json implementations.old.json
          # Append our implementation
          cat implementations.old.json \
            | jq '. + {"s2n-quic": {"image": "awslabs/s2n-quic-qns:latest", "url": "https://github.com/awslabs/s2n-quic", "role": "both"}}' \
            > implementations.json
          cat implementations.json

      - name: Run docker pull
        working-directory: quic-interop-runner
        run: |
          docker pull "martenseemann/quic-network-simulator@$NETWORK_SIMULATOR_REF"
          docker pull "martenseemann/quic-interop-iperf-endpoint@$IPERF_ENDPOINT_REF"

      - uses: actions/setup-python@v2
        with:
          python-version: 3.7

      - name: Install dependencies
        working-directory: quic-interop-runner
        run: |
          sudo add-apt-repository ppa:wireshark-dev/stable

          # azure packages are flaky! so add some retries
          sudo apt-get -o Acquire::Retries=3 update
          sudo apt-get -o Acquire::Retries=3 install -y tshark

          python3 -m pip install --upgrade pip
          pip3 install wheel
          pip3 install --upgrade -r requirements.txt

      - name: Run quic-interop-server
        working-directory: quic-interop-runner
        run: |
          mkdir -p results
          # enable IPv6 support
          sudo modprobe ip6table_filter
          python3 run.py --client ${{ matrix.client }} --server ${{ matrix.server }} --json results/result.json --debug --log-dir results/logs || true

      - name: Prepare artifacts
        working-directory: quic-interop-runner
        run: |
          ls -al results
          # clean up invalid path characters
          find results -name '*:*' | while read from; do
            echo "Invalid filename: $from"
            to=$(echo $from | sed 's/:/_/g')
            mv $from $to
          done
          # remove files we don't do anything with to reduce the artifact size
          find results -name '*.pcap' -exec rm {} \;
          find results -name '*.qlog' -exec rm {} \;

      - uses: actions/upload-artifact@v2
        with:
          name: interop-${{ matrix.client }}-client-${{ matrix.server }}-server
          path: quic-interop-runner/results/
  generate-report:
    runs-on: ubuntu-latest
    needs: [interop]
    steps:
      - uses: actions/checkout@v2

      - uses: actions/download-artifact@v2
        with:
          path: results/

      - name: Download latest results
        run: |
          rm -f result.json
          wget https://interop.seemann.io/logs/latest/result.json || echo '{}' > result.json
          mv result.json latest.json

      - name: Generate report
        run: |
          mkdir -p web/logs/latest
          python3 .github/interop/merge.py latest.json results/**/result.json > \
            web/logs/latest/result.json
          find results -maxdepth 3 -type d -wholename '*/logs/*' | while read from; do
            mv $from web/logs/latest/$(basename $from)
          done
          cat .github/interop/index.head.html web/logs/latest/result.json .github/interop/index.body.html > \
            web/index.html

      - uses: actions/upload-artifact@v2
        with:
          name: report
          path: web/

      - uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-1

      - name: Upload to S3
        id: s3
        run: |
          aws s3 sync web s3://s2n-quic-ci-artifacts/interop/${{ github.sha }} --acl private --follow-symlinks
          # generate a presigned url that is valid for 30 days
          URL=$(aws s3 presign s3://s2n-quic-ci-artifacts/interop/${{ github.sha }}/index.html --expires-in 2592000)
          echo "::set-output name=URL::$URL"

      - uses: ouzi-dev/commit-status-updater@v1.1.0
        with:
          name: 'interop / report'
          status: 'success'
          url: "${{ steps.s3.outputs.URL }}"
