on:
  workflow_dispatch:

name: ci

env:
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10
  RUST_BACKTRACE: 1
  # Pin the nightly toolchain to prevent breakage.
  # This should be occasionally updated.
  RUST_NIGHTLY_TOOLCHAIN: nightly-2025-03-31
  CDN: https://dnglbrstg7yg.cloudfront.net
  # enable unstable features for testing
  S2N_UNSTABLE_CRYPTO_OPT_TX: 100
  S2N_UNSTABLE_CRYPTO_OPT_RX: 100
  CI_ARTIFACTS_BUCKET: s2n-quic-ci-artifacts

# By default depandabot only receives read permissions. Explicitly give it write
# permissions which is needed by the ouzi-dev/commit-status-updater task.
#
# Updating status is relatively safe (doesnt modify source code) and caution
# should we taken before adding more permissions.
# permissions:
#   statuses: write
#   id-token: write # This is required for requesting the JWT/OIDC

jobs:
  ci-ai-fix:
    permissions:
      statuses: write
      id-token: write # This is required for requesting the JWT/OIDC
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          submodules: true

      - name: Install rust toolchain
        id: toolchain
        run: |
          rustup toolchain install stable --profile minimal
          rustup override set stable

      - uses: camshaft/install@v1
        with:
          crate: typos-cli
          bins: typos

      - uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          role-to-assume: arn:aws:iam::003495580562:role/GitHubOIDCRole
          role-session-name: S2nQuicBedrockSession
          aws-region: us-west-2

      - name: Invoke AWS Bedrock to fix CI failures
        run: |
          ./scripts/typos --format json | jq -c 'select(.type=="typo")' | ./scripts/bedrock.py --agent-id QNFDMSDYHR --agent-alias-id PON8LP9FEI

      - name: Create GenAI pull request
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: |
            ci: fix failing continuous integration test
          title: 'ü§ñ AI-Fix: correct failing CI test'
          body: |
            ### Description of changes: 
            This pull request was **automatically generated** by the AWS Bedrock‚Äìpowered CI assistant üß†.
            It identifies and corrects failing tests in the s2n-quic repository using generative AI.
            
            Specifically, this PR:
            - üß© Detects a failing CI test from the latest workflow run
            - üõ†Ô∏è Applies an AI-generated correction to the source or test code to restore passing status
            - üßæ Ensures that only the minimal, necessary changes are applied
            
            Reviewers should verify that the changes are correct and minimal. 

            ### Testing:
            - ‚úÖ The corrected test was re-executed in CI and now passes successfully  
            - üß™ All other test suites were run to confirm no regressions were introduced
            
            By submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.
