on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

name: qns

env:
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10
  RUST_BACKTRACE: 1
  # This kept breaking builds so we're pinning for now. We should do our best to keep
  # up with the changes, though.
  INTEROP_RUNNER_REF: 37c7eb05402c43ad1d7daa0e1c903db80f6478b9
  # This should be updated when updating wesleyrosenblum/quic-network-simulator
  NETWORK_SIMULATOR_REF: sha256:20abe0bed8c0e39e1d8750507b24295f7c978bdd7e05fa6f3a5afed4b76dc191
  IPERF_ENDPOINT_REF: sha256:cb50cc8019d45d9cad5faecbe46a3c21dd5e871949819a5175423755a9045106
  WIRESHARK_VERSION: 3.4.9
  CDN: https://dnglbrstg7yg.cloudfront.net
  LOG_URL: logs/latest/SERVER_CLIENT/TEST/index.html
  H3_SPEC_VERSION: v0.1.8
  QUINN_REF: 730fdaf723eef125c175fbcdba1ac3fe3324f7ce

jobs:
  env:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.implementations.outputs.matrix }}
    steps:
      - uses: ouzi-dev/commit-status-updater@v1.1.2
        with:
          name: 'interop / report'
          status: 'pending'

      - uses: ouzi-dev/commit-status-updater@v1.1.2
        with:
          name: 'bench / report'
          status: 'pending'

      - uses: actions/checkout@v2
        with:
          path: s2n-quic

      - uses: actions/checkout@v2
        with:
          repository: marten-seemann/quic-interop-runner
          ref: ${{ env.INTEROP_RUNNER_REF }}
          path: quic-interop-runner

      - name: Patch quic-interop-runner
        working-directory: quic-interop-runner
        run: |
          git apply --3way ../s2n-quic/.github/interop/runner.patch

      - name: Define implementations
        id: implementations
        working-directory: quic-interop-runner
        run: |
          CLIENTS=$(cat implementations.json \
            | jq -c '[. | to_entries[] | select(.value.role == "both" or .value.role == "client") | {"client": .key, "server": "s2n-quic"}] | sort'
          )
          echo "Clients: $CLIENTS"
          SERVERS=$(cat implementations.json \
            | jq -c '[. | to_entries[] | select(.value.role == "both" or .value.role == "server") | {"client": "s2n-quic", "server": .key}] | sort'
          )
          echo "Servers: $SERVERS"
          MATRIX=$(echo "[$CLIENTS, $SERVERS]" | jq -c '{"include": . | flatten | sort | unique}')
          echo "Matrix: $MATRIX"
          echo "::set-output name=matrix::$MATRIX"

  s2n-quic-qns:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mode: ["debug"]
    # enable debug information
    env:
      RUSTFLAGS: "-g"
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true

      - uses: actions-rs/toolchain@v1.0.7
        id: toolchain
        with:
          toolchain: stable
          profile: minimal
          override: true

      - uses: camshaft/rust-cache@v1
        with:
          key: ${{ matrix.mode }}-${{ env.RUSTFLAGS }}

      - name: Run cargo build
        uses: actions-rs/cargo@v1.0.3
        with:
          command: build
          args: --bin s2n-quic-qns ${{ matrix.mode == 'release' && '--release' || '' }}

      - name: Prepare artifact
        run: |
          mkdir -p s2n-quic-qns
          cp target/${{ matrix.mode }}/s2n-quic-qns s2n-quic-qns/s2n-quic-qns-${{ matrix.mode }}

      - uses: actions/upload-artifact@v2
        with:
          name: s2n-quic-qns-${{ matrix.mode }}
          path: s2n-quic-qns/

  h3spec:
    runs-on: ubuntu-latest
    needs: [s2n-quic-qns]

    steps:
      - uses: actions/download-artifact@v2
        with:
          name: s2n-quic-qns-debug

      - name: Install h3spec
        run: |
          curl -L -o h3spec https://github.com/kazu-yamamoto/h3spec/releases/download/$H3_SPEC_VERSION/h3spec-linux-x86_64
          chmod +x h3spec
          chmod +x s2n-quic-qns-debug

      - name: Run test
        # the skipped tests here require modifications to the TLS library
        # TODO remove the skips once these are fixed
        #      https://github.com/awslabs/s2n-quic/issues/858
        #      https://github.com/awslabs/s2n-quic/issues/859
        run: |
          ./s2n-quic-qns-debug interop server --port 4433 &
          # wait for the server to boot
          sleep 3
          ./h3spec localhost 4433 \
            ` h3spec appends the KeyUpdate message to the end of the valid Handshake data. `\
            ` s2n-quic considers the handshake "done" before it receives the bad message,  `\
            ` and instead fails because the bad message is considered leftover data. See:  `\
            ` https://github.com/awslabs/s2n-quic/blob/bb74c8e98adf12d805d26987fad02ffe45df97a7/quic/s2n-quic-transport/src/space/crypto_stream.rs#L64-L73 `\
            --skip "MUST send unexpected_message TLS alert if KeyUpdate in Handshake is received [TLS 6]" \
            \
            ` s2n-quic chooses to ignore CRYPTO frames in application data. See:           `\
            ` https://github.com/awslabs/s2n-quic/blob/bb74c8e98adf12d805d26987fad02ffe45df97a7/quic/s2n-quic-transport/src/space/application.rs#L625-L630 `\
            --skip "MUST send unexpected_message TLS alert if KeyUpdate in 1-RTT is received [TLS 6]" \
            \
            ` The quic_transport_parameters are part of the ClientHello.                   `\
            ` s2n-quic currently does not respond to malformed ClientHellos. See:          `\
            ` https://github.com/awslabs/s2n-quic/blob/bb74c8e98adf12d805d26987fad02ffe45df97a7/quic/s2n-quic-transport/src/endpoint/mod.rs#L725 `\
            --skip "MUST send missing_extension TLS alert if the quic_transport_parameters extension does not included [TLS 8.2]"

